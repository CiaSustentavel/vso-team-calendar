{"version":3,"sources":["Calendar/EventSources/VSOIterationEventSource.ts"],"names":["VSOIterationEventSource","VSOIterationEventSource.constructor","VSOIterationEventSource.getEvents","VSOIterationEventSource.getCategories","VSOIterationEventSource._getCategoryData","VSOIterationEventSource._isCurrentIteration"],"mappings":"AAAA,+CAA+C;;IAe/C;QAAAA;YAEWC,OAAEA,GAAGA,YAAYA,CAACA;YAClBA,SAAIA,GAAGA,YAAYA,CAACA;YACpBA,UAAKA,GAAGA,EAAEA,CAACA;YACXA,eAAUA,GAAGA,IAAIA,CAACA;QAoG7BA,CAACA;QAjGUD,2CAASA,GAAhBA,UAAiBA,KAAsCA;YAAvDE,iBAyCCA;YAvCGA,IAAIA,MAAMA,GAAuCA,EAAEA,CAACA;YACpDA,IAAIA,QAAQA,GAAGA,CAACA,CAACA,KAAKA,EAAsCA,CAACA;YAC7DA,IAAIA,CAACA,OAAOA,GAAGA,IAAIA,CAACA;YAEpBA,IAAIA,UAAUA,GAAGA,GAAGA,CAACA,aAAaA,EAAEA,CAACA;YACrCA,IAAIA,WAAWA,GAAmCA,EAAEA,SAASA,EAAEA,UAAUA,CAACA,OAAOA,CAACA,EAAEA,EAAEA,MAAMA,EAAEA,UAAUA,CAACA,IAAIA,CAACA,EAAEA,EAAEA,OAAOA,EAAEA,EAAEA,EAAEA,IAAIA,EAAEA,EAAEA,EAAEA,CAACA;YAC1IA,IAAIA,UAAUA,GAA+BA,OAAOA,CAACA,aAAaA;iBAC7DA,aAAaA,EAAEA;iBACfA,aAAaA,CAACA,WAAWA,CAACA,cAAcA,EAAEA,gBAAgBA,CAACA,oBAAoBA,CAACA,GAAGA,CAACA,CAACA;YAG1FA,UAAUA,CAACA,iBAAiBA,CAACA,WAAWA,CAACA,CAACA,IAAIA,CAC1CA,UAACA,UAAkDA;gBAC/CA,UAAUA,CAACA,OAAOA,CAACA,UAACA,SAA+CA,EAAEA,KAAaA,EAAEA,KAA6CA;oBAC7HA,EAAEA,CAACA,CAACA,SAASA,IAAIA,SAASA,CAACA,UAAUA,IAAIA,SAASA,CAACA,UAAUA,CAACA,SAASA,CAACA,CAACA,CAACA;wBACtEA,IAAIA,KAAKA,GAAQA,EAAEA,CAACA;wBACpBA,KAAKA,CAACA,SAASA,GAAGA,UAAUA,CAACA,UAAUA,CAACA,SAASA,CAACA,UAAUA,CAACA,SAASA,CAACA,CAACA;wBACxEA,EAAEA,CAACA,CAACA,SAASA,CAACA,UAAUA,CAACA,UAAUA,CAACA,CAACA,CAACA;4BAClCA,KAAKA,CAACA,OAAOA,GAAGA,UAAUA,CAACA,UAAUA,CAACA,SAASA,CAACA,UAAUA,CAACA,UAAUA,CAACA,CAACA;wBAC3EA,CAACA;wBACDA,KAAKA,CAACA,KAAKA,GAAGA,SAASA,CAACA,IAAIA,CAACA;wBAC7BA,EAAEA,CAACA,CAACA,KAAIA,CAACA,mBAAmBA,CAACA,KAAKA,CAACA,CAACA,CAACA,CAACA;4BAClCA,KAAKA,CAACA,QAAQA,GAAGA,SAASA,CAACA,IAAIA,CAACA;wBACpCA,CAACA;wBAEDA,MAAMA,CAACA,IAAIA,CAACA,KAAKA,CAACA,CAACA;oBACvBA,CAACA;gBACTA,CAACA,CAACA,CAACA;gBAEHA,MAAMA,CAACA,IAAIA,CAACA,UAACA,CAACA,EAAEA,CAACA,IAAOA,MAAMA,CAACA,CAACA,CAACA,SAASA,CAACA,OAAOA,EAAEA,GAAGA,CAACA,CAACA,SAASA,CAACA,OAAOA,EAAEA,CAACA,CAACA,CAACA,CAACA,CAACA;gBACjFA,KAAIA,CAACA,OAAOA,GAAGA,MAAMA,CAACA;gBACtBA,QAAQA,CAACA,OAAOA,CAACA,MAAMA,CAACA,CAACA;YAE7BA,CAACA,EACDA,UAACA,CAAQA;gBACLA,QAAQA,CAACA,MAAMA,CAACA,CAACA,CAACA,CAACA;YACvBA,CAACA,CAACA,CAACA;YAEHA,MAAMA,CAACA,QAAQA,CAACA,OAAOA,CAACA;QAC5BA,CAACA;QAEMF,+CAAaA,GAApBA,UAAqBA,KAAqCA;YAA1DG,iBAcCA;YAbGA,IAAIA,QAAQA,GAAGA,CAACA,CAACA,KAAKA,EAAOA,CAACA;YAC9BA,EAAEA,CAACA,CAACA,IAAIA,CAACA,OAAOA,CAACA,CAACA,CAACA;gBACfA,QAAQA,CAACA,OAAOA,CAACA,IAAIA,CAACA,gBAAgBA,CAACA,IAAIA,CAACA,OAAOA,CAACA,KAAKA,CAACA,CAACA,CAACA,EAAEA,KAAKA,CAACA,CAACA,CAACA;YAE1EA,CAACA;YACDA,IAAIA,CAACA,CAACA;gBACFA,IAAIA,CAACA,SAASA,EAAEA,CAACA,IAAIA,CACjBA,UAACA,MAA0CA;oBACvCA,QAAQA,CAACA,OAAOA,CAACA,KAAIA,CAACA,gBAAgBA,CAACA,MAAMA,EAAEA,KAAKA,CAACA,CAACA,CAACA;gBAC3DA,CAACA,CAACA,CAACA;YACXA,CAACA;YAEDA,MAAMA,CAACA,QAAQA,CAACA,OAAOA,CAACA;QAC5BA,CAACA;QAEOH,kDAAgBA,GAAxBA,UAAyBA,MAA0CA,EAAEA,KAAqCA;YACtGI,IAAIA,UAAUA,GAAwCA,EAAEA,CAACA;YAEzDA,CAACA,CAACA,IAAIA,CAACA,MAAMA,CAACA,MAAMA,CAACA,CAACA,CAACA,CAACA,IAAIA,CAACA,UAACA,EAAoCA,EAAEA,EAAoCA;gBACpGA,EAAEA,CAACA,CAACA,CAACA,EAAEA,CAACA,SAASA,IAAIA,CAACA,EAAEA,CAACA,OAAOA,CAACA,CAACA,CAACA;oBAC/BA,MAAMA,CAACA,CAACA,CAACA;gBACbA,CAACA;gBAEDA,MAAMA,CAACA,EAAEA,CAACA,SAASA,CAACA,OAAOA,EAAEA,GAAGA,EAAEA,CAACA,SAASA,CAACA,OAAOA,EAAEA,CAACA;YAC3DA,CAACA,CAACA,EACEA,UAACA,KAAaA,EAAEA,KAAuCA;gBACnDA,EAAEA,CAACA,CAACA,kBAAkBA,CAACA,OAAOA,CAACA,KAAKA,EAAEA,KAAKA,CAACA,CAACA,CAACA,CAACA;oBAC3CA,IAAIA,QAAQA,GAAsCA;wBAC9CA,KAAKA,EAAEA,KAAKA,CAACA,KAAKA;wBAClBA,QAAQA,EAAEA,YAAYA,CAACA,MAAMA,CAACA,WAAWA,EACrCA,UAAUA,CAACA,MAAMA,CAACA,KAAKA,CAACA,SAASA,EAAEA,GAAGA,CAACA,EACvCA,UAAUA,CAACA,MAAMA,CAACA,KAAKA,CAACA,OAAOA,EAAEA,GAAGA,CAACA,CAACA;qBAC7CA,CAACA;oBACFA,EAAEA,CAACA,CAACA,KAAKA,CAACA,QAAQA,CAACA,CAACA,CAACA;wBACjBA,QAAQA,CAACA,KAAKA,GAAGA,mBAAmBA,CAACA,uBAAuBA,CAACA,KAAKA,CAACA,KAAKA,CAACA,CAAAA;oBAC7EA,CAACA;oBACDA,IAAIA,CAACA,CAACA;wBACFA,QAAQA,CAACA,KAAKA,GAAGA,SAASA,CAACA;oBAC/BA,CAACA;oBACDA,UAAUA,CAACA,IAAIA,CAACA,QAAQA,CAACA,CAACA;gBAC9BA,CAACA;YACLA,CAACA,CAACA,CAACA;YAEPA,MAAMA,CAACA,UAAUA,CAACA;QACtBA,CAACA;QAEOJ,qDAAmBA,GAA3BA,UAA4BA,KAAuCA;YAC/DK,EAAEA,CAACA,CAACA,KAAKA,CAACA,SAASA,IAAIA,KAAKA,CAACA,OAAOA,CAACA,CAACA,CAACA;gBACnCA,IAAIA,KAAKA,GAASA,UAAUA,CAACA,UAAUA,CAACA,IAAIA,IAAIA,EAAEA,CAACA,CAACA;gBACpDA,MAAMA,CAACA,KAAKA,IAAIA,KAAKA,CAACA,SAASA,IAAIA,KAAKA,IAAIA,KAAKA,CAACA,OAAOA,CAACA;YAC9DA,CAACA;YACDA,MAAMA,CAACA,KAAKA,CAACA;QACjBA,CAACA;QACLL,8BAACA;IAADA,CAzGA,AAyGCA,IAAA;IAzGY,+BAAuB,0BAyGnC,CAAA","file":"Calendar/EventSources/VSOIterationEventSource.js","sourcesContent":["/// <reference path='../../ref/VSS/VSS.d.ts' />\r\n\r\nimport Calendar_Contracts = require(\"Calendar/Contracts\");\r\nimport Calendar_ColorUtils = require(\"Calendar/Utils/Color\");\r\nimport Calendar_DateUtils = require(\"Calendar/Utils/Date\");\r\nimport Q = require(\"q\");\r\nimport Service = require(\"VSS/Service\");\r\nimport TFS_Core_Contracts = require(\"TFS/Core/Contracts\");\r\nimport Utils_Core = require(\"VSS/Utils/Core\");\r\nimport Utils_Date = require(\"VSS/Utils/Date\");\r\nimport Utils_String = require(\"VSS/Utils/String\");\r\nimport WebApi_Constants = require(\"VSS/WebApi/Constants\");\r\nimport Work_Client = require(\"TFS/Work/RestClient\");\r\nimport Work_Contracts = require(\"TFS/Work/Contracts\");\r\n\r\nexport class VSOIterationEventSource implements Calendar_Contracts.IEventSource {\r\n\r\n    public id = \"iterations\";\r\n    public name = \"Iterations\";\r\n    public order = 20;\r\n    public background = true;\r\n    private _events: Calendar_Contracts.CalendarEvent[];\r\n\r\n    public getEvents(query?: Calendar_Contracts.IEventQuery): IPromise<Calendar_Contracts.CalendarEvent[]> {\r\n\r\n        var result: Calendar_Contracts.CalendarEvent[] = [];\r\n        var deferred = Q.defer<Calendar_Contracts.CalendarEvent[]>();\r\n        this._events = null;\r\n\r\n        var webContext = VSS.getWebContext();\r\n        var teamContext: TFS_Core_Contracts.TeamContext = { projectId: webContext.project.id, teamId: webContext.team.id, project: \"\", team: \"\" };\r\n        var workClient: Work_Client.WorkHttpClient = Service.VssConnection\r\n            .getConnection()\r\n            .getHttpClient(Work_Client.WorkHttpClient, WebApi_Constants.ServiceInstanceTypes.TFS);\r\n\r\n        // fetch the wit events\r\n        workClient.getTeamIterations(teamContext).then(\r\n            (iterations: Work_Contracts.TeamSettingsIteration[]) => {\r\n                iterations.forEach((iteration: Work_Contracts.TeamSettingsIteration, index: number, array: Work_Contracts.TeamSettingsIteration[]) => {\r\n                    if (iteration && iteration.attributes && iteration.attributes.startDate) {\r\n                        var event: any = {};\r\n                        event.startDate = Utils_Date.shiftToUTC(iteration.attributes.startDate);\r\n                        if (iteration.attributes.finishDate) {\r\n                            event.endDate = Utils_Date.shiftToUTC(iteration.attributes.finishDate);\r\n                        }\r\n                        event.title = iteration.name;\r\n                        if (this._isCurrentIteration(event)) {\r\n                            event.category = iteration.name;\r\n                        }\r\n\r\n                        result.push(event);\r\n                    }\r\n            });\r\n\r\n            result.sort((a, b) => { return a.startDate.valueOf() - b.startDate.valueOf(); });\r\n            this._events = result;\r\n            deferred.resolve(result);\r\n\r\n        },\r\n        (e: Error) => {\r\n            deferred.reject(e);\r\n        });\r\n\r\n        return deferred.promise;\r\n    }\r\n\r\n    public getCategories(query: Calendar_Contracts.IEventQuery): IPromise<Calendar_Contracts.IEventCategory[]> {\r\n        var deferred = Q.defer<any>();\r\n        if (this._events) {\r\n            deferred.resolve(this._getCategoryData(this._events.slice(0), query));\r\n            \r\n        }\r\n        else {\r\n            this.getEvents().then(\r\n                (events: Calendar_Contracts.CalendarEvent[]) => {\r\n                    deferred.resolve(this._getCategoryData(events, query));\r\n                });\r\n        }\r\n\r\n        return deferred.promise;\r\n    }\r\n\r\n    private _getCategoryData(events: Calendar_Contracts.CalendarEvent[], query: Calendar_Contracts.IEventQuery): Calendar_Contracts.IEventCategory[]{\r\n        var categories: Calendar_Contracts.IEventCategory[] = [];\r\n\r\n        $.each(events.splice(0).sort((e1: Calendar_Contracts.CalendarEvent, e2: Calendar_Contracts.CalendarEvent) => {\r\n            if (!e1.startDate || !e2.endDate) {\r\n                return 0;\r\n            }\r\n\r\n            return e1.startDate.getTime() - e2.startDate.getTime();\r\n        }),\r\n            (index: number, event: Calendar_Contracts.CalendarEvent) => {\r\n                if (Calendar_DateUtils.eventIn(event, query)) {\r\n                    var category: Calendar_Contracts.IEventCategory = {\r\n                        title: event.title,\r\n                        subTitle: Utils_String.format(\"{0} - {1}\",\r\n                            Utils_Date.format(event.startDate, \"M\"),\r\n                            Utils_Date.format(event.endDate, \"M\")),\r\n                    };\r\n                    if (event.category) {\r\n                        category.color = Calendar_ColorUtils.generateBackgroundColor(event.title)\r\n                    }\r\n                    else {\r\n                        category.color = \"#FFFFFF\";\r\n                    }\r\n                    categories.push(category);\r\n                }\r\n            });\r\n\r\n        return categories;\r\n    }\r\n\r\n    private _isCurrentIteration(event: Calendar_Contracts.CalendarEvent): boolean {\r\n        if (event.startDate && event.endDate) {\r\n            var today: Date = Utils_Date.shiftToUTC(new Date());\r\n            return today >= event.startDate && today <= event.endDate;\r\n        }\r\n        return false;\r\n    }\r\n}"],"sourceRoot":"/source/"}